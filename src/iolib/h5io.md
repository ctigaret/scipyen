
# Writing objects to HDF5 entities: 
```python
makeHDF5Entity(obj, group, name, oname, compression, chunks, track_order, entity_cache)
```
where: 
* `obj`: the Python object to be stored in the HDF5 entity
* `group`: the HDF5 Group (`hyp5.Group`) where the newly created entity will be stored as a child entity; this can be a HDF5 File (`hyp5.File`).
* `name`: the name of the entity (`str`) 
* `oname`: the name of the Python object
* `compression`: the type of HDF5 data compression (`str`); default is `"gzip"`
* `chunks`: flag whether to use HDF5 chunks (`bool`); default is `None`
* `track_order`: flag whether to track the order in which new entities are inserted (`bool`); default is `True`
* `entity_cache`: dictionary with previously created entities; default is `dict()`; this will avoid data duplications; cached entities are stored as "soft" links

**NOTE:** The last four arguments are passed down the call chain to the various entity creation functions called by `makeHDF5Entity`.

Creates a HDF5 Group (`h5py.Group`) or Dataset (`h5py.Dataset`) as shown in Table 1.

Relevant object attributes are stored as `attrs` property of the HDF5 entity (`Group` or `Dataset`).
***
#### Table 1 - Mapping of Python type to HDF5 Entity
| Object (super) type                              | HDF5 Entity   | Relevant object attributes¹                                        |
|--------------------------------------------------|---------------|--------------------------------------------------------------------|
| pandas.DataFrame, pandas.Series                  | Group         | data type attributes, recommended attributes                       |
| vigra.VigraArray                                 | Group         | data type attributes                                               |
| neo.core.baseneo.BaseNeo²                        | Group         | data type attributes, recommended attributes                       |
| neo.ChannelView                                  | Group         | data type attributes, recommended attributes                       |
| TriggerProtocol                                  | Group         | data type attributes                                               |                                                                  |
| collections.abc.Iterable³                        | Group         | data type attributes                                               |
| vigra.filters.Kernel1D, vigra.filters.Kernel2D   | Dataset       | data type attributes, data set attributes, recommended attributes⁴ |
| enum.Enum (and derived)                          | Dataset       | data type attributes, data set attributes                          |
| NoneType                                         | Empty Dataset |                                                                    |
| Anything else⁵                                   | Dataset       | data type attributes, data set attributes                          |

¹ see below

² includes scipyen types DataSignal, IrregularlySampledDataSignal, DataZone, DataMark, TriggerEvent, ScanData, and AnalysisUnit

³ except for str, bytes, bytearray, np.ndarray

⁴ where appropriate, e.g. `neo` object types, `scipyen` object types

⁵ including str, bytes, bytearray, numpy.ndarray, and quantities.Quantity

***

## Relevant object attributes
These are generated by the `makeObjAttrs` function.
```python
target_name, obj_attrs = makeObjAttrs(obj, oname)
```
where: 
* `obj` is a Python object, 
* `oname` is the object's desired name (as will be stored in the `attrs`); 

Returns:
* `target_name`: `name` attribute of the entity; this gives the name of the newly create entity (e.g in `makeHDF5Entity`); it may be overwritten in the caller
* `obj_attrs`: dictionary that maps relevant object attribute name to their *JSON-encoded* values and can be stored as `attrs` property of the HDF5 entity.

A set of relevant object properties are stored in the `attrs` property of the 
HDF5 entities created to represent the objects. These properties are data type
attributes, data set attributes, and attribute recommended for certain object 
types.

### Data type attributes 
Generated by `makeDataTypeAttrs(obj)` function.

This is a dict with the following key/value mappings: 
* `type_name`    → `type(obj).__name__`
* `module_name`  → `type(obj).__module__` 
* `python_class` →  <`module_name`>.<`type_name`>

Data type attributes are attached to the primary HDF5 entity that encapsulates 
the object (a Group or a Dataset, see Table 1).

### Data set attributes 
Generated by `makeDatasetAttrs(obj)`, a `singledispatch` function which returns a
dict with the keys listed in Table 2, below. The dict is empty for any object 
type not mentioned in Table 2.

When objects are stored *directly* as HDF5 Dataset (see Table 1), these attributes 
are attached to the corresponding Dataset. Otherwise, they are attached to the 
"data" Dataset child of the Group that represents the object in HDF5 (see also
the section **Storing objects as Group**, below).

***
#### Table 2
| Object type                                     | key                   | observations                                |
|-------------------------------------------------|-----------------------|---------------------------------------------|
| vigra.filters.Kernel1D, vigra.filters.Kernel2D  | dtype                 | stored after convertions to `numpy.ndarray` |
| numpy.ndarray                                   | dtype, dtype_fields   | dtype_fields only for structured arrays
| quantities.Quantity                             | dtype, units          |
| neo.core.dataobject.DataObject                  | dtype, units,         | 
| vigra.Array                                     | dtype, axistags       |

***

### Recommended attributes
Managed by `makeObjAttrs` function
These are specific to object types defined in the `neo` package and in `scipyen`,
and are listed in the `class` property `_recommended_attrs`, with some exceptions.

Typically, they are:
* `name`
* `file_origin`
* `description`
* `file_datetime`⁴
* `rec_datetime`⁴
* `waveforms` - only for neo.SpikeTrain therefore NOT used here, but stored as a separate entity in the Group for the SpikeTrain.

⁴  except for neo.Group, neo.ChannelView, neo.ImageSequence, neo.Epoch, neo.Event, DataMark, TriggerEvent, DataZone

Not all are present in all types.

The `makeObjAttrs` function calls `makeAttrDict` to encode data in JSON.
    
### Necessary attributes (not used)
These are specific to object types defined in the `neo` package and in `scipyen` and are listed in the 
`class` property `_necessary_attrs`

### Parent attrs (not used)
These are specific to object types defined in the `neo` package and in `scipyen` and are listed in the 
`class` property `_parent_attrs`

## Storing objects as Dataset
The following object types are encoded directly as Dataset:
* `quantity.Quantity`
* `numpy.ndarray`
* `str`
* `bytes`
* `bytearray`
* `NoneType`

The `attrs` property of the Dataset is generated by `makeDatasetAttr` (dispatched on obj type) which calls `makeAttrDict`.


## Storing objects as Group
Collections (dict, Iterables and neo Container) are stored as HDF5 Group entities
by `makeHDF5Group` function via the `singledispatch` function `makeGroup`.

Other special types that are stored as Group are managed by `makeHDF5Dataset`
function (which delegates to the `singledispatch` function `makeDataset`)

***
#### Table 3: Group structure for objects stored as HDF5 Group
| Object type       | Encoding functions            | Child name(s)                               | Child type       | Observations                                                                                     |
|-------------------|-------------------------------|---------------------------------------------|------------------|--------------------------------------------------------------------------------------------------|
| dict              | makeHDF5Group,   makeGroup    | dict key                                    | Group or Dataset | Depends on the type of the value mapped to the key                                               |
| Iterable          | makeHDF5Group,   makeGroup    | \<element index\>_\<element type name\>     | Group or Dataset | Depends on the type of the element at the index                                                  |
| neo Container     | makeHDF5Group,   makeGroup    | taken from the `_child_containers` property | Group or Dataset |                                                                                                  |
| VigraArray        | makeHDF5Dataset, makeDataset, |                data                         | Dataset          | Contains the array data                                                                          |
|                   |                               |                axes                         | Group            | Contains one Dataset per axis⁶, with axes attributes stored in the axis Dataset `attrs` property |
| neo DataObject    | makeHDF5Dataset, makeDataset  |                data                         | Dataset          | Contains the array data                                                                          |
|                   |                               |                axes                         | Group            | Contains one Dataset per axis⁶, with axes attributes stored in the axis Dataset `attrs` property. Each axis Dataset is used to create an AxisScale for the main "\<group_name\>_data" Dataset | 
|                   |                               |                labels⁷                      | Dataset          |  | 
|                   |                               |                waveforms⁷                   | Dataset          |  | 
|                   |                               |                annotations⁷                 | Group            |  | 
|                   |                               |                segment⁷                     | Group            | typically a soft link to an existing neo Container (segment) group | 
| pandas DataFrame  |makeHDF5Dataset, makeHDF5Group | data                                        | Dataset          |
|                   |                               | categories                                  | Group            |

⁶ Details about axis Datasets are given below.
⁷ Where appropriate

## Axes Datasets for VigraArray and neo DataObject types
Created by `makeAxisScale` function, wich calls `makeAxisDict` function.

In turn, `makeAxisDict` is dispatched to create a dict with axis
attributes depending on the dimension corresponding to the axis and the object 
type.
